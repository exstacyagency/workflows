name: security-sweep

on:
  pull_request:
  workflow_dispatch:

jobs:
  security-sweep:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      SECURITY_SWEEP: "1"
      DEBUG_ADMIN_TOKEN: ${{ secrets.DEBUG_ADMIN_TOKEN }}
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
    steps:
      - uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install
        run: npm ci

      - name: Provision Neon branch + DB (CI)
        id: neon
        shell: bash
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
          NEON_DB_PASSWORD: ${{ secrets.NEON_DB_PASSWORD }}
        run: |
          set -euo pipefail
          BRANCH_NAME="ci-pr-${{ github.event.pull_request.number || github.run_id }}-${{ github.run_id }}"
          DB_NAME="workflows_ci_${{ github.run_id }}"

          echo "Creating Neon branch: $BRANCH_NAME"
          BRANCH_JSON=$(curl -sS -X POST \
            -H "Authorization: Bearer ${NEON_API_KEY}" \
            -H "Content-Type: application/json" \
            "https://console.neon.tech/api/v2/projects/${NEON_PROJECT_ID}/branches" \
            -d "{\"branch\":{\"name\":\"${BRANCH_NAME}\"}}")

          BRANCH_ID=$(echo "$BRANCH_JSON" | node -pe "JSON.parse(fs.readFileSync(0,'utf8')).branch.id")
          echo "branch_id=${BRANCH_ID}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "db_name=${DB_NAME}" >> $GITHUB_OUTPUT

          echo "Creating database: $DB_NAME"
          curl -sS -X POST \
            -H "Authorization: Bearer ${NEON_API_KEY}" \
            -H "Content-Type: application/json" \
            "https://console.neon.tech/api/v2/projects/${NEON_PROJECT_ID}/branches/${BRANCH_ID}/databases" \
            -d "{\"database\":{\"name\":\"${DB_NAME}\"}}" >/dev/null

          echo "Fetching Neon endpoint host for branch ${BRANCH_ID} (polling)"
          HOST=""
          for i in $(seq 1 30); do
            ENDPOINTS_JSON=$(curl -sS \
              -H "Authorization: Bearer ${NEON_API_KEY}" \
              "https://console.neon.tech/api/v2/projects/${NEON_PROJECT_ID}/branches/${BRANCH_ID}/endpoints")

            HOST=$(echo "$ENDPOINTS_JSON" | node -pe "
              const j = JSON.parse(fs.readFileSync(0,'utf8'));
              const ep = (j?.endpoints && j.endpoints.length) ? j.endpoints[0] : null;
              const host = ep?.host || ep?.proxy_host || '';
              process.stdout.write(host);
            ")

            if [ -n "$HOST" ]; then
              echo "Endpoint host ready: $HOST"
              break
            fi

            echo "No endpoint yet (attempt $i/30). Waiting 2s..."
            sleep 2
          done

          if [ -z "$HOST" ]; then
            echo "No endpoint host found after polling." >&2
            echo "$ENDPOINTS_JSON" >&2
            exit 1
          fi

          ROLE='${{ secrets.NEON_ROLE }}'
          if [ -z \"${ROLE}\" ]; then ROLE=\"neondb_owner\"; fi
          if [ -z \"${NEON_DB_PASSWORD}\" ]; then echo \"Missing NEON_DB_PASSWORD secret\" >&2; exit 1; fi

          # Prisma DATABASE_URL with password
          DATABASE_URL=postgresql://${ROLE}:${NEON_DB_PASSWORD}@${HOST}/${DB_NAME}?sslmode=require
          echo "DATABASE_URL=${DATABASE_URL}" >> $GITHUB_ENV
          echo "DATABASE_URL_PREFIX=postgresql://${ROLE}:***@${HOST}/${DB_NAME}" >> $GITHUB_ENV
          echo "DATABASE_URL set for CI (host=${HOST}, db=${DB_NAME})"

      - name: Prisma migrate deploy (CI DB)
        run: |
          echo "DATABASE_URL_PREFIX=${DATABASE_URL_PREFIX}"
          npx prisma migrate deploy

      - name: Bootstrap dev data (CI)
        run: npm run bootstrap:dev

      - name: Build
        run: npm run build

      - name: Start server
        run: |
          npm run dev -- --port 3000 &
          echo $! > server.pid

      - name: Wait for health
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:3000/api/health >/dev/null; then
              echo "healthy"
              exit 0
            fi
            sleep 1
          done
          echo "server did not become healthy" >&2
          exit 1

      - name: Run attacker sweep
        run: npm run security:sweep

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

      - name: Cleanup Neon branch
        if: always()
        shell: bash
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
        run: |
          set -euo pipefail
          BRANCH_ID="${{ steps.neon.outputs.branch_id }}"
          if [ -n "${BRANCH_ID}" ]; then
            echo "Deleting Neon branch ${BRANCH_ID}"
            curl -sS -X DELETE \
              -H "Authorization: Bearer ${NEON_API_KEY}" \
              "https://console.neon.tech/api/v2/projects/${NEON_PROJECT_ID}/branches/${BRANCH_ID}" \
              >/dev/null || true
          fi
