generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// CORE OWNERSHIP  //
//////////////////////

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  name             String?
  passwordHash     String?
  stripeCustomerId String?  @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  accountId        String?
  account          Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)

  projects         Project[]
  auditLogs        AuditLog[]
  subscription     Subscription?
  usage            Usage[]

  @@map("user")
}

model Project {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  jobs                 Job[]
  scripts              Script[]
  storyboards          Storyboard[]
  characters           Character[]
  researchRows         ResearchRow[]
  adAssets             AdAsset[]
  adPatternResults     AdPatternResult[]
  adPatternReferences  AdPatternReference[]
  customerAvatars      CustomerAvatar[]
  productIntelligences ProductIntelligence[]
  auditLogs            AuditLog[]

  @@index([userId])
  @@map("project")
}

//////////////////////
// ACCOUNTS & CRM   //
//////////////////////

model Account {
  id        String      @id @default(cuid())
  tier      AccountTier @default(FREE)
  spend     Int         @default(0)
  spendCap  Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  users     User[]
  campaigns Campaign[]
  spendEvents SpendEvent[]

  @@map("account")
}

model Campaign {
  id        String   @id @default(cuid())
  accountId String
  name      String
  state     CampaignState @default(DRAFT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@map("campaign")
}

model SpendEvent {
  id        String   @id @default(cuid())
  accountId String
  amount    Int
  sourceId  String   @unique
  createdAt DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@map("spend_event")
}

//////////////////////
// JOBS & LOGGING  //
//////////////////////

model Job {
  id             String   @id @default(uuid())
  projectId      String
  userId         String
  type           String
  status         JobStatus @default(PENDING)
  currentStep    String?
  idempotencyKey String
  payload        Json
  resultSummary  Json?
  error          String?
  estimatedCost  Int?
  actualCost     Int?
  costBreakdown  Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  scripts          Script[]
  storyboards      Storyboard[]
  characters       Character[]
  researchRows     ResearchRow[]
  adAssets         AdAsset[]
  adPatternResults AdPatternResult[]
  auditLogs        AuditLog[]

  @@index([projectId])
  @@unique([userId, projectId, idempotencyKey])
  @@map("job")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  projectId String?
  jobId     String?
  action    String
  metadata  Json?
  ip        String?
  createdAt DateTime @default(now())

  user    User?    @relation(fields: [userId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])
  job     Job?     @relation(fields: [jobId], references: [id])

  @@index([userId])
  @@index([projectId])
  @@index([jobId])
  @@map("audit_log")
}

//////////////////////
// DOMAIN TABLES   //
//////////////////////

model ResearchRow {
  id         String         @id @default(uuid())
  projectId  String
  jobId      String?
  source     ResearchSource
  content    String
  metadata   Json?
  createdAt  DateTime       @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  job     Job?    @relation(fields: [jobId], references: [id])

  @@index([projectId])
  @@map("research_row")
}

model Script {
  id                String   @id @default(cuid())
  projectId         String
  jobId             String?
  mergedVideoUrl    String?
  upscaledVideoUrl  String?
  status            ScriptStatus
  rawJson           Json
  wordCount         Int?
  upscaleError      String?
  createdAt         DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  job     Job?    @relation(fields: [jobId], references: [id])
  storyboards Storyboard[]

  @@map("script")
}

model Storyboard {
  id        String   @id @default(uuid())
  projectId String
  jobId     String?
  scriptId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  job     Job?    @relation(fields: [jobId], references: [id])
  script  Script? @relation(fields: [scriptId], references: [id])

  scenes StoryboardScene[]

  @@index([projectId])
  @@map("storyboard")
}

model StoryboardScene {
  id           String   @id @default(uuid())
  storyboardId String
  sceneNumber  Int
  rawJson      Json?
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  storyboard Storyboard @relation(fields: [storyboardId], references: [id], onDelete: Cascade)

  @@index([storyboardId])
  @@map("storyboard_scene")
}

//////////////////////
// ADDITIONAL DOMAIN //
//////////////////////

model Character {
  id        String   @id @default(uuid())
  projectId String
  jobId     String?
  name      String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  job     Job?    @relation(fields: [jobId], references: [id])

  @@index([projectId])
  @@map("character")
}

model AdAsset {
  id        String     @id @default(uuid())
  projectId String
  jobId     String?
  platform  AdPlatform
  rawJson   Json
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  job     Job?    @relation(fields: [jobId], references: [id])

  @@index([projectId])
  @@map("ad_asset")
}

model AdPatternResult {
  id        String   @id @default(uuid())
  projectId String
  jobId     String?
  summary   String?
  rawJson   Json?
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  job     Job?    @relation(fields: [jobId], references: [id])

  @@index([projectId])
  @@map("ad_pattern_result")
}

model AdPatternReference {
  id        String   @id @default(uuid())
  projectId String
  source    String
  metadata  Json?
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("ad_pattern_reference")
}

model CustomerAvatar {
  id        String   @id @default(uuid())
  projectId String
  name      String?
  persona   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("customer_avatar")
}

model ProductIntelligence {
  id        String   @id @default(uuid())
  projectId String
  insights  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("product_intelligence")
}

//////////////////////
// BILLING / AUTH  //
//////////////////////

model Subscription {
  id       String  @id @default(cuid())
  userId   String  @unique
  planId   PlanId
  status   String  @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscription")
}

model Usage {
  id       String   @id @default(cuid())
  userId   String
  period   DateTime
  jobsUsed Int      @default(0)

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, period])
  @@map("usage")
}

//////////////////////
// ENUMS          //
//////////////////////

enum JobType {
  CUSTOMER_RESEARCH
  CUSTOMER_ANALYSIS
  PATTERN_ANALYSIS
  SCRIPT_GENERATION
  STORYBOARD_GENERATION
  VIDEO_PROMPT_GENERATION
  VIDEO_IMAGE_GENERATION
  VIDEO_GENERATION
  VIDEO_REVIEW
  VIDEO_UPSCALER
  AD_PERFORMANCE
}

enum ResearchSource {
  REDDIT_PRODUCT
  REDDIT_PROBLEM
  AMAZON
  G2
  LOCAL_BUSINESS
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum PlanId {
  FREE
  GROWTH
  SCALE
}

enum AccountTier {
  FREE
  GROWTH
  SCALE
}

enum AdPlatform {
  TIKTOK
  META
}

enum CampaignState {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

// Script lifecycle statuses. Values chosen to match status strings used across the codebase.
enum ScriptStatus {
  seeded
  PENDING
  READY
  upscaled
  upscale_pending
  upscale_failed
}