generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String        @id @default(cuid())
  email            String        @unique
  name             String?
  passwordHash     String?
  stripeCustomerId String?       @unique
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  accountId        String?
  testSessions     TestSession[]
  auditLogs        AuditLog[]
  projects         Project[]
  subscription     Subscription?
  usage            Usage[]
  account          Account?      @relation(fields: [accountId], references: [id])

  @@map("user")
}

model TestSession {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Project {
  id                       String                @id @default(uuid())
  userId                   String
  name                     String
  description              String?
  creatorReferenceImageUrl String?
  productReferenceImageUrl String?
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt
  adAssets                 AdAsset[]
  adPatternReferences      AdPatternReference[]
  adPatternResults         AdPatternResult[]
  amazonReviews            AmazonReview[]
  auditLogs                AuditLog[]
  characters               Character[]
  customerAvatars          CustomerAvatar[]
  jobs                     Job[]
  product                  product[]
  productIntels            ProductIntel[]
  productIntelligences     ProductIntelligence[]
  user                     User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  researchRows             ResearchRow[]
  researchRuns             ResearchRun[]
  scripts                  Script[]
  storyboards              Storyboard[]

  @@unique([userId, name])
  @@index([userId])
  @@map("project")
}

model Account {
  id          String       @id @default(cuid())
  tier        AccountTier  @default(FREE)
  spendCap    Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  spend       Int          @default(0)
  campaigns   Campaign[]
  spendEvents SpendEvent[]
  users       User[]

  @@map("account")
}

model Campaign {
  id        String        @id @default(cuid())
  accountId String
  name      String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  state     CampaignState @default(DRAFT)
  account   Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@map("campaign")
}

model SpendEvent {
  id        String   @id @default(cuid())
  accountId String
  amount    Int
  sourceId  String   @unique
  createdAt DateTime @default(now())
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@map("spend_event")
}

model ResearchRun {
  id        String    @id @default(uuid())
  projectId String
  name      String?
  status    RunStatus @default(IN_PROGRESS)
  createdAt DateTime  @default(now())
  jobs      Job[]
  characters Character[]
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("research_run")
}

model Job {
  id               String            @id @default(uuid())
  projectId        String
  type             JobType
  status           JobStatus         @default(PENDING)
  idempotencyKey   String
  payload          Json
  resultSummary    Json?
  estimatedCost    Int?
  actualCost       Int?
  costBreakdown    Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  currentStep      String?
  userId           String
  determinism      String?
  failureCode      String?
  fixtureVersion   Int?
  runtimeMode      String?
  error            Json?
  runId            String?
  adAssets         AdAsset[]
  adPatternResults AdPatternResult[]
  amazonReviews    AmazonReview[]
  auditLogs        AuditLog[]
  characters       Character[]
  project          Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  researchRun      ResearchRun?      @relation(fields: [runId], references: [id])
  productIntels    ProductIntel[]
  researchRows     ResearchRow[]
  scripts          Script[]
  storyboards      Storyboard[]

  @@unique([id, userId])
  @@unique([userId, projectId, idempotencyKey])
  @@index([projectId])
  @@index([runId])
  @@map("job")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  projectId String?
  jobId     String?
  action    String
  metadata  Json?
  ip        String?
  createdAt DateTime @default(now())
  job       Job?     @relation(fields: [jobId], references: [id])
  project   Project? @relation(fields: [projectId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([projectId])
  @@index([jobId])
  @@map("audit_log")
}

model ResearchRow {
  id               String         @id @default(uuid())
  projectId        String
  jobId            String?
  source           ResearchSource
  content          String
  metadata         Json?
  createdAt        DateTime       @default(now())
  type             String
  problemKeyword   String?
  productAsin      String?
  productName      String?
  productType      ProductType?
  rating           Int?
  redditCreatedUtc BigInt?
  redditId         String?
  redditParentId   String?
  searchQueryUsed  String?
  solutionKeyword  String?
  subreddit        String?
  updatedAt        DateTime       @updatedAt
  job              Job?           @relation(fields: [jobId], references: [id])
  project          Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([jobId])
  @@index([source])
  @@index([productType])
  @@index([subreddit])
  @@index([solutionKeyword])
  @@index([redditCreatedUtc])
  @@map("research_row")
}

model AmazonReview {
  id          String      @id @default(uuid())
  projectId   String
  jobId       String?
  reviewText  String
  rating      Int?
  verified    Boolean?
  reviewDate  DateTime?
  rawJson     Json?
  productType ProductType
  productAsin String
  productName String?
  createdAt   DateTime    @default(now())
  job         Job?        @relation(fields: [jobId], references: [id])
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([jobId])
  @@index([productType])
  @@map("amazon_review")
}

model Script {
  id               String       @id @default(cuid())
  projectId        String
  jobId            String?
  mergedVideoUrl   String?
  upscaledVideoUrl String?
  status           ScriptStatus
  rawJson          Json
  wordCount        Int?
  upscaleError     String?
  createdAt        DateTime     @default(now())
  job              Job?         @relation(fields: [jobId], references: [id])
  project          Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  storyboards      Storyboard[]

  @@map("script")
}

model Storyboard {
  id           String            @id @default(uuid())
  projectId    String
  jobId        String?
  scriptId     String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  job          Job?              @relation(fields: [jobId], references: [id])
  project      Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  script       Script?           @relation(fields: [scriptId], references: [id])
  scenes       StoryboardScene[]
  imagePrompts ImagePrompt[]

  @@index([projectId])
  @@map("storyboard")
}

model StoryboardScene {
  id           String     @id @default(uuid())
  storyboardId String
  sceneNumber  Int
  clipDurationSeconds Int? @default(10)
  panelType    PanelType? @default(ON_CAMERA)
  firstFrameImageUrl String?
  lastFrameImageUrl  String?
  rawJson      Json?
  approved     Boolean    @default(false)
  status       String     @default("pending")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  storyboard   Storyboard @relation(fields: [storyboardId], references: [id], onDelete: Cascade)

  @@index([storyboardId])
  @@map("storyboard_scene")
}

model ImagePrompt {
  id           String     @id @default(uuid())
  storyboardId String
  sceneNumber  Int
  prompt       String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  storyboard   Storyboard @relation(fields: [storyboardId], references: [id], onDelete: Cascade)

  @@unique([storyboardId, sceneNumber])
  @@index([storyboardId])
  @@map("image_prompt")
}

model Character {
  id                  String   @id @default(uuid())
  projectId           String?
  productId           String?
  jobId               String?
  runId               String?
  name                String
  metadata            Json?
  soraCharacterId     String?
  characterUserName   String?
  seedVideoTaskId     String?
  seedVideoUrl        String?
  creatorVisualPrompt String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  job                 Job?     @relation(fields: [jobId], references: [id])
  run                 ResearchRun? @relation(fields: [runId], references: [id])
  project             Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  product             product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([productId])
  @@index([runId])
  @@map("character")
}

model AdAsset {
  id                String     @id @default(uuid())
  projectId         String
  jobId             String?
  platform          AdPlatform
  rawJson           Json
  isSwipeFile       Boolean    @default(false)
  swipeCandidate    Boolean    @default(false)
  swipeMetadata     Json?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  contentViable     Boolean?
  qualityIssue      String?
  qualityConfidence Int?
  qualityReason     String?
  retention_3s      Float?
  retention_10s     Float?
  retention_3s_ctr  Float?
  retention_10s_ctr Float?
  retention_3s_cvr  Float?
  retention_10s_cvr Float?
  duration          Int?
  source_type       String?
  engagement_score  Float?
  job               Job?       @relation(fields: [jobId], references: [id])
  project           Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("ad_asset")
}

model AdPatternResult {
  id        String   @id @default(uuid())
  projectId String
  jobId     String?
  summary   String?
  rawJson   Json?
  createdAt DateTime @default(now())
  job       Job?     @relation(fields: [jobId], references: [id])
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("ad_pattern_result")
}

model AdPatternReference {
  id        String   @id @default(uuid())
  projectId String
  source    String
  metadata  Json?
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("ad_pattern_reference")
}

model CustomerAvatar {
  id                  String   @id @default(uuid())
  projectId           String
  name                String?
  persona             Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  competitiveInsights Json?
  project             Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("customer_avatar")
}

model ProductIntelligence {
  id        String   @id @default(uuid())
  projectId String
  insights  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("product_intelligence")
}

model ProductIntel {
  id                 String   @id @default(cuid())
  projectId          String
  jobId              String
  url                String
  productName        String
  tagline            String?
  keyFeatures        String[]
  ingredientsOrSpecs String[]
  price              String?
  keyClaims          String[]
  targetAudience     String?
  usp                String?
  rawHtml            String?
  createdAt          DateTime @default(now())
  job                Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  project            Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([jobId])
  @@map("product_intel")
}

model Subscription {
  id        String   @id @default(cuid())
  userId    String   @unique
  planId    PlanId
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscription")
}

model Usage {
  id       String   @id @default(cuid())
  userId   String
  period   DateTime
  jobsUsed Int      @default(0)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([userId, period])
  @@map("usage")
}

model product {
  id                         String    @id
  project_id                 String
  name                       String
  product_problem_solved     String?
  amazon_asin                String?
  creatorReferenceImageUrl   String?   @map("creator_reference_image_url")
  productReferenceImageUrl   String?   @map("product_reference_image_url")
  characterReferenceVideoUrl String?   @map("character_reference_video_url")
  soraCharacterId            String?   @map("sora_character_id")
  characterCameoCreatedAt    DateTime? @map("character_cameo_created_at") @db.Timestamptz(6)
  creatorVisualPrompt        String?   @map("creator_visual_prompt")
  characterSeedVideoTaskId   String?   @map("character_seed_video_task_id")
  characterSeedVideoUrl      String?   @map("character_seed_video_url")
  characterUserName          String?   @map("character_user_name")
  character_anchor_prompt    String?
  character_avatar_image_url String?
  created_at                 DateTime  @default(now()) @db.Timestamptz(6)
  updated_at                 DateTime  @default(now()) @db.Timestamptz(6)
  characters                 Character[]
  project                    Project   @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([project_id, name], map: "product_project_name_unique")
  @@index([project_id])
}

enum JobType {
  CUSTOMER_RESEARCH
  CUSTOMER_ANALYSIS
  PATTERN_ANALYSIS
  SCRIPT_GENERATION
  STORYBOARD_GENERATION
  IMAGE_PROMPT_GENERATION
  VIDEO_PROMPT_GENERATION
  VIDEO_IMAGE_GENERATION
  CREATOR_AVATAR_GENERATION
  CHARACTER_SEED_VIDEO
  CHARACTER_REFERENCE_VIDEO
  VIDEO_GENERATION
  VIDEO_REVIEW
  VIDEO_UPSCALER
  AD_PERFORMANCE
  PRODUCT_DATA_COLLECTION
  PRODUCT_ANALYSIS
  AD_QUALITY_GATE
}

enum ProductType {
  MAIN_PRODUCT
  COMPETITOR_1
  COMPETITOR_2
  COMPETITOR_3
}

enum ResearchSource {
  REDDIT_PRODUCT
  REDDIT_PROBLEM
  AMAZON
  G2
  UPLOADED
  AMAZON_MAIN_PRODUCT
  AMAZON_COMPETITOR_1
  AMAZON_COMPETITOR_2
  AMAZON_COMPETITOR_3
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum PlanId {
  FREE
  GROWTH
  SCALE
}

enum AccountTier {
  FREE
  GROWTH
  SCALE
}

enum AdPlatform {
  TIKTOK
  META
}

enum CampaignState {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum ScriptStatus {
  seeded
  PENDING
  READY
  upscaled
  upscale_pending
  upscale_failed
}

enum RunStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum PanelType {
  ON_CAMERA
  PRODUCT_ONLY
  B_ROLL_ONLY
}
