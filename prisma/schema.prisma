// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String        @id @default(cuid())
  email            String        @unique
  name             String?
  passwordHash     String?
  stripeCustomerId String?       @unique
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  accountId        String?
  auditLogs        AuditLog[]
  projects         Project[]
  subscription     Subscription?
  usage            Usage[]
  account          Account?      @relation(fields: [accountId], references: [id])

  testSessions     TestSession[]

  @@map("user")
}

model TestSession {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Project {
  id                   String                @id @default(uuid())
  userId               String
  name                 String
  description          String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  adAssets             AdAsset[]
  adPatternReferences  AdPatternReference[]
  adPatternResults     AdPatternResult[]
  auditLogs            AuditLog[]
  characters           Character[]
  customerAvatars      CustomerAvatar[]
  jobs                 Job[]
  productIntelligences ProductIntelligence[]
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  researchRows         ResearchRow[]
  researchRuns         ResearchRun[]
  scripts              Script[]
  storyboards          Storyboard[]

  @@index([userId])
  @@unique([userId, name])
  @@map("project")
}

model Account {
  id          String       @id @default(cuid())
  tier        AccountTier  @default(FREE)
  spendCap    Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  spend       Int          @default(0)
  campaigns   Campaign[]
  spendEvents SpendEvent[]
  users       User[]

  @@map("account")
}

model Campaign {
  id        String        @id @default(cuid())
  accountId String
  name      String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  state     CampaignState @default(DRAFT)
  account   Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@map("campaign")
}

model SpendEvent {
  id        String   @id @default(cuid())
  accountId String
  amount    Int
  sourceId  String   @unique
  createdAt DateTime @default(now())
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@map("spend_event")
}

model ResearchRun {
  id        String    @id @default(uuid())
  projectId String
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  status    RunStatus @default(IN_PROGRESS)
  createdAt DateTime  @default(now())
  jobs      Job[]

  @@index([projectId])
  @@map("research_run")
}

model Job {
  id               String            @id @default(uuid())
  projectId        String
  type             JobType
  status           JobStatus         @default(PENDING)
  idempotencyKey   String
  payload          Json
  resultSummary    Json?
  error            Json?
  estimatedCost    Int?
  actualCost       Int?
  costBreakdown    Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  currentStep      String?
  userId           String
  runtimeMode      String?
  determinism      String?
  failureCode      String?
  fixtureVersion   Int?
  runId            String?
  adAssets         AdAsset[]
  adPatternResults AdPatternResult[]
  auditLogs        AuditLog[]
  characters       Character[]
  project          Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  researchRows     ResearchRow[]
  scripts          Script[]
  storyboards      Storyboard[]
  researchRun      ResearchRun?      @relation(fields: [runId], references: [id])

  @@unique([id, userId])
  @@unique([userId, projectId, idempotencyKey])
  @@index([projectId])
  @@index([runId])
  @@map("job")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  projectId String?
  jobId     String?
  action    String
  metadata  Json?
  ip        String?
  createdAt DateTime @default(now())
  job       Job?     @relation(fields: [jobId], references: [id])
  project   Project? @relation(fields: [projectId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([projectId])
  @@index([jobId])
  @@map("audit_log")
}

model ResearchRow {
  id        String         @id @default(uuid())
  projectId String
  jobId     String?
  source    ResearchSource
  content   String
  metadata  Json?
  createdAt DateTime       @default(now())
  job       Job?           @relation(fields: [jobId], references: [id])
  project   Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("research_row")
}

model Script {
  id               String       @id @default(cuid())
  projectId        String
  jobId            String?
  mergedVideoUrl   String?
  upscaledVideoUrl String?
  status           ScriptStatus
  rawJson          Json
  wordCount        Int?
  upscaleError     String?
  createdAt        DateTime     @default(now())
  job              Job?         @relation(fields: [jobId], references: [id])
  project          Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  storyboards      Storyboard[]

  @@map("script")
}

model Storyboard {
  id        String            @id @default(uuid())
  projectId String
  jobId     String?
  scriptId  String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  job       Job?              @relation(fields: [jobId], references: [id])
  project   Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  script    Script?           @relation(fields: [scriptId], references: [id])
  scenes    StoryboardScene[]

  @@index([projectId])
  @@map("storyboard")
}

model StoryboardScene {
  id           String     @id @default(uuid())
  storyboardId String
  sceneNumber  Int
  rawJson      Json?
  status       String     @default("pending")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  storyboard   Storyboard @relation(fields: [storyboardId], references: [id], onDelete: Cascade)

  @@index([storyboardId])
  @@map("storyboard_scene")
}

model Character {
  id        String   @id @default(uuid())
  projectId String
  jobId     String?
  name      String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  job       Job?     @relation(fields: [jobId], references: [id])
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("character")
}

model AdAsset {
  id        String     @id @default(uuid())
  projectId String
  jobId     String?
  platform  AdPlatform
  rawJson   Json
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  job       Job?       @relation(fields: [jobId], references: [id])
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("ad_asset")
}

model AdPatternResult {
  id        String   @id @default(uuid())
  projectId String
  jobId     String?
  summary   String?
  rawJson   Json?
  createdAt DateTime @default(now())
  job       Job?     @relation(fields: [jobId], references: [id])
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("ad_pattern_result")
}

model AdPatternReference {
  id        String   @id @default(uuid())
  projectId String
  source    String
  metadata  Json?
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("ad_pattern_reference")
}

model CustomerAvatar {
  id        String   @id @default(uuid())
  projectId String
  name      String?
  persona   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("customer_avatar")
}

model ProductIntelligence {
  id        String   @id @default(uuid())
  projectId String
  insights  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("product_intelligence")
}

model Subscription {
  id        String   @id @default(cuid())
  userId    String   @unique
  planId    PlanId
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscription")
}

model Usage {
  id       String   @id @default(cuid())
  userId   String
  period   DateTime
  jobsUsed Int      @default(0)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([userId, period])
  @@map("usage")
}

enum JobType {
  CUSTOMER_RESEARCH
  CUSTOMER_ANALYSIS
  PATTERN_ANALYSIS
  SCRIPT_GENERATION
  STORYBOARD_GENERATION
  VIDEO_PROMPT_GENERATION
  VIDEO_IMAGE_GENERATION
  VIDEO_GENERATION
  VIDEO_REVIEW
  VIDEO_UPSCALER
  AD_PERFORMANCE
  PRODUCT_DATA_COLLECTION
  PRODUCT_ANALYSIS
}

enum ResearchSource {
  REDDIT_PRODUCT
  REDDIT_PROBLEM
  AMAZON
  G2
  LOCAL_BUSINESS
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum PlanId {
  FREE
  GROWTH
  SCALE
}

enum AccountTier {
  FREE
  GROWTH
  SCALE
}

enum AdPlatform {
  TIKTOK
  META
}

enum CampaignState {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum ScriptStatus {
  seeded
  PENDING
  READY
  upscaled
  upscale_pending
  upscale_failed
}

enum RunStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
}
